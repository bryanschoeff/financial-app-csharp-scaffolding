calcs = {};
nav = {};

$(document).ready(function() {

  // -----------------------------------------------------------------
  //  Totals Fields Calculations and Auto-Updates
  // -----------------------------------------------------------------
  <% @calculations.each do |calculation, fields| %>
  calcs.<%= calculation %> = function() {
    $('#<%= calculation %>').html(<% fields.each do |field| %><% if field.calculated %>parseInt($('#<%= "#{field.calculation_table}_#{field.calculated_name}" %>').html())<% else %>parseInt($('#<%= "#{field.calculation_table}_#{field.csharp_name}" %>').val())<% end %><%= (fields.last == field) ? ");" : " +" %>
    <% end %>}
  <% end %>
  
  calcs.updateTotals = function(callback) {
	<% @calculations.each do |calculation, fields| %>
	calcs.<%= calculation %>();<% end %>
	
	if (callback) { callback(); }
  }

  $('.statement-money').blur(function() {
	calcs.updateTotals(calcs.updateTotals());
  });
  
  calcs.updateTotals();
  
  // -----------------------------------------------------------------
  //  Navigation Functions
  // -----------------------------------------------------------------
  nav.saveProgress = function() {
	$.post('/<%= "#{@entity_type}#{@filing_type}/EditAsync/" %>', $('form').serialize(), function(data) {
	  helpers.showMessage(data);
	});
  }
  
  nav.hideAll = function() {
	<% @tables.each do |table| %>
	$('#<%= table.name %>').hide();<% end %>
  }
  
  nav.show = function(current) {
	nav.hideAll();
	$('#' + current).show();
  }
  
  nav.removeAllActive = function() {
	$('.filing-nav').removeClass('filing-nav-active');
  }
  
  nav.setActive = function(current) {
	nav.removeAllActive();
	$('#' + current).addClass('filing-nav-active');
  }
  nav.next = function (current) {
    $('.filing-nav-active').parent().next().children('a').removeClass('disabled');
    $('.filing-nav-active').parent().next().children('a').click();
  }

  nav.previous = function (current) {
    $('.filing-nav-active').parent().prev().children('a').click();
  }
  
  nav.returnToTop = function () {
    window.scrollTo(0, 0);
    //$('body').animate({ scrollTop: 0 }, 1000);
    //return false;
  }

  // Run once
  
  $('.filing-nav').click(function() {
	if ($(this).hasClass('disabled')) return;
	var id = $(this).attr('id');
	var fieldset = id.replace('nav-', '');
	nav.show(fieldset);
	nav.setActive(id);
	nav.saveProgress();
	nav.returnToTop();
  });
  
  $('#nav-previous').click(function () {
    nav.previous();
  });
  
  $('#nav-next').click(function () {
	nav.next();
  });

  $('.filing-nav').addClass('disabled');
  $('.filing-nav').first().removeClass('disabled');
  
  nav.show('<%= @tables.first.name %>');
  $('.filing-nav').first().addClass('filing-nav-active');
  
});
