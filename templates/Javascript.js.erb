filingsApp = {};
filingsApp.calcs = {};
filingsApp.nav = {};

$(document).ready(function() {

  // -----------------------------------------------------------------
  //  Totals Fields Calculations and Auto-Updates
  // -----------------------------------------------------------------
  <% @calculations.each do |calculation, fields| %>
  filingsApp.calcs.<%= calculation %> = function() {
    $('#<%= calculation %>').html(<% fields.each do |field| %><% if field.calculated %>parseInt($('#<%= "#{field.calculation_table}_#{field.calculated_name}" %>').html())<% else %>parseInt($('#<%= "#{field.calculation_table}_#{field.csharp_name}" %>').val())<% end %><%= (fields.last == field) ? ");" : " +" %>
  <% end %>}
  <% end %>
  
  filingsApp.calcs.updateTotals = function(callback) {
	<% @calculations.each do |calculation, fields| %>
	filingsApp.calcs.<%= calculation %>();<% end %>
	
	if (callback) { callback(); }
  }

  $('.statement-money').blur(function() {
	$(this).val(Math.floor($(this).val()));
	filingsApp.calcs.updateTotals(filingsApp.calcs.updateTotals());
  });
  
  filingsApp.calcs.updateTotals();
  
  // -----------------------------------------------------------------
  //  Navigation Functions
  // -----------------------------------------------------------------
  filingsApp.nav.saveProgress = function() {
	$.post('/<%= "#{@entity_type}#{@filing_type}/EditAsync/" %>', $('form').serialize(), function(data) {
	  helpers.showMessage(data);
	});
  }
  
  filingsApp.nav.hideAll = function () {
        $('.tabpage').hide();
    }

    filingsApp.nav.show = function (current) {
        filingsApp.nav.hideAll();
        $('#' + current).show();
    }

    filingsApp.nav.removeAllActive = function () {
        $('.filing-filingsApp.nav').removeClass('filing-filingsApp.nav-active');
    }

    filingsApp.nav.setActive = function (current) {
        filingsApp.nav.removeAllActive();
        $('#' + current).addClass('filing-filingsApp.nav-active');
    }

    filingsApp.nav.unlock = function (current) {
        var id = $(current).attr('id');
        var fieldset = id.replace('filingsApp.nav-', '');

        $('#' + id).removeClass('disabled');
        $('#' + fieldset + '_Unlocked').val("True");

    }

    filingsApp.nav.next = function (current) {
        var newSection = $('.filing-filingsApp.nav-active').parent().next().children('a');
        filingsApp.nav.unlock($(newSection));
        $(newSection).click();
    }

    filingsApp.nav.previous = function (current) {
        $('.filing-filingsApp.nav-active').parent().prev().children('a').click();
    }

    filingsApp.nav.returnToTop = function () {
        window.scrollTo(0, 0);
        //$('body').animate({ scrollTop: 0 }, 1000);
        //return false;
    }

    // Run once

    $('.filing-filingsApp.nav').click(function () {
        if ($(this).hasClass('disabled')) return;

        var id = $(this).attr('id');
        var fieldset = id.replace('filingsApp.nav-', '');

        filingsApp.nav.show(fieldset);
        filingsApp.nav.setActive(id);
        filingsApp.nav.saveProgress();
        filingsApp.nav.returnToTop();
    });

    $('#filingsApp.nav-previous').click(function () {
        filingsApp.nav.previous();
    });

    $('#filingsApp.nav-next').click(function () {
        filingsApp.nav.next();
    });
	
	$('.not-applicable').click(function() {
		filingsApp.nav.disablePage($(this).parent());
		filingsApp.nav.next();
	});

    $('.tabpage').each(function () {
        var id = $(this).attr('id');
        if ($('#' + id + '_Unlocked').val() === 'False') { $('#filingsApp.nav-' + id).addClass('disabled'); }
    }, filingsApp.nav.unlock($('.tabpage').first()));
	
    filingsApp.nav.show('SONP_GovernmentalActivities');
    $('.filing-filingsApp.nav').first().addClass('filing-filingsApp.nav-active');

});
