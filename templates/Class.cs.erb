using System.Data.SqlClient;
using System.Configuration;

namespace <%= "#{@entity_type}.#{@filing_type}" %>
{
  public class <%= @name %>
  {
    public int Id { get; set; }
    <% @fields.each do |field| %>
    public <%= "#{field.csharp_type} #{field.csharp_name} { get; set; }"  %><% end %>

    public <%= @name %>()
    {
      this.Id = -1;
    }
    
    public void Load(int Id)
    {
      using (SqlConnection connection = new SqlConnection(ConfigurationManager.ConnectionStrings["connection"].ConnectionString + ";initial catalog=OnlineFinancialStatements"))
      {
        SqlCommand command = new SqlCommand("<%= print_sql_sp_name_load %>", connection);
        SqlDataReader reader;
        
        command.Parameters.AddWithValue("@<%= @name  %>Id", Id);

        connection.Open();
        reader = command.ExecuteReader();                                                   
        reader.Read();  
        <% @fields.each do |field| %>
        this.<%= field.csharp_name %> = (decimal)reader["<%= field.sql_column_name %>"];<% end %>
      
        connection.Close();
      }
    }

    public void Save()
    {
      if (this.Id == -1)
      {
        SaveNew();
      }
      else
      {
        Update();
      }
    }

    protected void SaveNew()
    {
      using (SqlConnection connection = new SqlConnection(ConfigurationManager.ConnectionStrings["connection"].ConnectionString + ";initial catalog=OnlineFinancialStatements"))
      {
        SqlCommand command = new SqlCommand("<%= print_sql_sp_name_save %>", connection);
        
        <% @fields.each do |field| %>
        command.Parameters.AddWithValue("<%= field.sql_parameter  %>", this.<%= field.csharp_name %>);<% end %>

        connection.Open();
        this.Id = (int)command.ExecuteScalar();
        connection.Close();
      }
    }

    protected void Update()
    {
      using (SqlConnection connection = new SqlConnection(ConfigurationManager.ConnectionStrings["connection"].ConnectionString + ";initial catalog=OnlineFinancialStatements"))
      {
        SqlCommand command = new SqlCommand("<%= print_sql_sp_name_update %>", connection);

        command.Parameters.AddWithValue("@<%= @name %>Id", this.Id);
        <% @fields.each do |field| %>
        command.Parameters.AddWithValue("<%= field.sql_parameter  %>", this.<%= field.csharp_name %>);<% end %>

        connection.Open();
        command.ExecuteNonQuery();  
        connection.Close();
      }
    }

    public void Delete()
    {
      using (SqlConnection connection = new SqlConnection(ConfigurationManager.ConnectionStrings["connection"].ConnectionString + ";initial catalog=OnlineFinancialStatements"))
      {
        SqlCommand command = new SqlCommand("<%= print_sql_sp_name_delete %>", connection);

        command.Parameters.AddWithValue("@<%= @name %>Id", this.Id);

        connection.Open();
        command.ExecuteNonQuery();  
        connection.Close();
      }
    }
  }
}
